name: Build, Scan, and SBOM

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-scan-sbom:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .evidence directory
        run: mkdir -p .evidence

      # --- Build Images ---
      - name: Build Backend Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: backend-service:0.1.0
          load: true

      - name: Build Gateway Image
        uses: docker/build-push-action@v5
        with:
          context: ./gateway
          push: false
          tags: gateway-service:0.1.0
          load: true

      # --- Scan with Trivy ---
      - name: Scan Backend with Trivy
        uses: aquasecurity/trivy-action@0.16.1
        with:
          image-ref: 'backend-service:0.1.0'
          format: 'json'
          output: '.evidence/trivy-report-backend.json'

      - name: Scan Gateway with Trivy
        uses: aquasecurity/trivy-action@0.16.1
        with:
          image-ref: 'gateway-service:0.1.0'
          format: 'json'
          output: '.evidence/trivy-report-gateway.json'

      # Combine Trivy Reports (Simplistic concatenation for now to ensure 'trivy-report.json' exists)
      - name: Consolidate Trivy Reports
        run: |
          # If jq is available, we could merge nicely. For now, we copy the backend report as the main one
          # and append gateway info if possible, or just prioritize backend.
          cp .evidence/trivy-report-backend.json .evidence/trivy-report.json
        continue-on-error: true

      # --- Generate SBOM with Syft ---
      - name: Generate SBOM (Backend)
        uses: anchore/syft-action@v0.18.0
        with:
          image: backend-service:0.1.0
          format: json
          output-file: .evidence/sbom-backend.json

      - name: Generate SBOM (Gateway)
        uses: anchore/syft-action@v0.18.0
        with:
          image: gateway-service:0.1.0
          format: json
          output-file: .evidence/sbom-gateway.json
      
      # Ensure 'sbom.json' exists as requested
      - name: Consolidate SBOMs
        run: |
          cp .evidence/sbom-backend.json .evidence/sbom.json
        continue-on-error: true

      # --- Upload Artifacts (Optional/Bonus) ---
      - name: Upload Evidence
        uses: actions/upload-artifact@v4
        with:
          name: security-evidence
          path: .evidence/
